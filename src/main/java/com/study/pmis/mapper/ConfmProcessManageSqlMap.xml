<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao">

    <!-- 승인 처리 대상 건 조회 -->
    <select id="selectListConfmProcessTrget" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
		SELECT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.selectListConfmProcessTrget */
			   t2.reqst_id
		     , t2.lnbns_schdul_id
		     , t2.applcnt_id
		     , (SELECT nm FROM tb_ae_user_info WHERE user_sn = t2.user_sn and use_at = 'Y' and mber_secsn_at = 'N') AS applcnt_nm
		     , t2.reqst_de
		     , t2.reqst_sttus_code
		     , t1.reqst_sttus_code as process_sttus
		     , t2.lnbns_de
		     , t2.lnbns_time_code
		     , t2.lnbns_time_odr
		     , t2.lnbns_time
		     , t2.instt_code
		     , t1.vhcle_id
		     , t1.nm
		     , t1.mbtlnum
		     , t1.applcnt_sn
		     , t1.indvdl_info_use_agre_at
		     , t1.file_atch_agre_at
		     , t1.brthdy
		     , t1.sexdstn
		     , case when t1.native_se_code = '1' then '내국인'
			        else '외국인' end AS native_se_code_nm  /* 내국인 구분 코드 명 */
			 , (SELECT small_cl_code_nm FROM tb_ae_cmmn_code_cl WHERE lrge_cl_code = '1005' AND small_cl_code = t1.nation_code) AS nation_code_nm /* 국가 코드 명 */
			 , (SELECT small_cl_code_nm FROM tb_ae_cmmn_code_cl WHERE lrge_cl_code = 'P008' AND small_cl_code = t1.sexdstn) AS sexdstn_nm /* 성별 명 */
			 , (SELECT small_cl_code_nm FROM tb_ae_cmmn_code_cl WHERE lrge_cl_code = 'P009' AND small_cl_code = t2.reqst_sttus_code) AS reqst_sttus_code_nm /* 신청 상태 코드 명 */
			 , (SELECT small_cl_code_nm FROM tb_ae_cmmn_code_cl WHERE lrge_cl_code = 'P009' AND small_cl_code = t1.reqst_sttus_code) AS process_sttus_nm /* 처리 상태 코드 명 */
			 , CASE WHEN t1.indvdl_info_use_agre_at = 'Y' THEN '동의'
			        ELSE '미동의'
			    END AS agre_at_nm
			 , t1.lnbns_man_ty_code /* 견학 자 유형[P012] */
			 , (SELECT small_cl_code_nm FROM tb_ae_cmmn_code_cl WHERE lrge_cl_code = 'P012' AND small_cl_code = t1.lnbns_man_ty_code) AS lnbns_man_ty_nm /* 견학 자 유형[P012] */
			 , t1.clss_nd_ofcps /* 계급 및 직위 */
			 , t3.vhcle_num
			 <!-- , t1.POLICE_IDNTY_INQIRE_RESULT -->
			 , CASE WHEN t1.POLICE_IDNTY_INQIRE_RESULT = 'X' AND T5.POLICE_IMPROPT_RESN_CD IS NULL
			        THEN t1.POLICE_IDNTY_INQIRE_RESULT || '(미처리)'
			        WHEN  t1.POLICE_IDNTY_INQIRE_RESULT = 'X' AND T5.POLICE_IMPROPT_RESN_CD IS NOT NULL
			        THEN t1.POLICE_IDNTY_INQIRE_RESULT || '(처리완료)'
			 		ELSE t1.POLICE_IDNTY_INQIRE_RESULT END AS policeIdntyInqireResult
			 , CASE WHEN t4.file_cnt <![CDATA[>]]> 1 THEN  file_nm || ' 외(' || TO_CHAR(t4.file_cnt-1) || ' 건)'
			 		WHEN t4.file_cnt <![CDATA[>]]> 0 THEN  file_nm
			 		ELSE '' END AS file_nm
			 , ROW_NUMBER() OVER(ORDER BY t2.reqst_id, t1.applcnt_sn) AS row_num
			 <!-- , CASE WHEN TO_DATE(t2.lnbns_de,'YYYYMMDD') <![CDATA[>=]]> SYSDATE -14 AND TO_DATE(t2.lnbns_de,'YYYYMMDD') <![CDATA[<=]]> SYSDATE - 7 THEN 'Y' ELSE 'N' END AS canConfmAt -->
			 , t2.lnbns_se_code
			 , t2.cancl_prvonsh
			 , t2.shuttle_bus_brdng_at
		  FROM tb_up_reqst_hn_matter t1
		 INNER JOIN (
					SELECT t1.reqst_id
					     , t2.lnbns_schdul_id
					     , t1.applcnt_id
					     , t1.reqst_de
					     , t1.reqst_sttus_code
					     , t1.process_sttus
					     , t1.lnbns_de
					     , t2.lnbns_time_code
					     , t1.lnbns_time_odr
					     , t1.lnbns_time
					     , t4.instt_code
					     , t1.lnbns_se_code
					     , t1.user_sn
					     , t1.cancl_prvonsh
					     , t1.shuttle_bus_brdng_at
					  FROM tb_up_reqst_info t1
					 INNER JOIN tb_up_lnbns_schdul_info t2
					    ON t1.lnbns_schdul_id = t2.lnbns_schdul_id
					   AND t2.delete_at = 'N'
					 INNER JOIN tb_up_env_setup_info t3
					    ON t3.env_setup_code = t2.lnbns_time_code
					   AND t3.stdr_value_se_code = #{stdrValueSeCode}
					 INNER JOIN tb_up_stdr_de_info t4
					    ON t1.lnbns_de = t4.stdr_de
					 WHERE t1.delete_at = 'N'
					   AND t1.reqst_sttus_code = '1'
		 	 ) t2
		    ON t1.reqst_id = t2.reqst_id
		 LEFT OUTER JOIN (
					SELECT lnbns_schdul_id
					     , vhcle_id
						 , vhcle_odr AS  vhcle_num
					  FROM tb_up_lnbns_vhcle_info
					 WHERE delete_at = 'N'	
		     ) t3
		    ON t1.lnbns_schdul_id = t3.lnbns_schdul_id
		   AND t1.vhcle_id = t3.vhcle_id
		 LEFT OUTER JOIN TB_UP_POLICE_IDNTY_INQIRE t5
		    ON t1.reqst_id = t5.reqst_id
		   AND t1.APPLCNT_SN = t5.APPLCNT_SN
		  LEFT OUTER
		  JOIN (
				SELECT reqst_id
				     , max(file_nm) AS file_nm 
				     , count(file_nm)  AS file_cnt
				  FROM tb_up_reqst_atch_doc 
				 WHERE reqst_id
				 GROUP BY reqst_id  
		     ) t4
		    ON t1.reqst_id = t4.reqst_id
	 WHERE 0=0
	   AND t1.delete_at = 'N'
	<if test="srchReqstDeBegin != null and srchReqstDeBegin != ''">
		<if test="srchReqstDeEnd != null and srchReqstDeEnd != ''">
		   AND t2.reqst_de BETWEEN REPLACE(#{srchReqstDeBegin}, '-') AND REPLACE(#{srchReqstDeEnd}, '-')
		</if>
		<if test="srchReqstDeEnd eq null or srchReqstDeEnd eq ''">
		   AND t2.reqst_de = REPLACE(#{srchReqstDeBegin}, '-')
		</if>
	</if>
	<if test="srchLnbnsDeBegin != null and srchLnbnsDeBegin != ''">
		<if test="srchLnbnsDeEnd != null and srchLnbnsDeEnd != ''">
		   AND t2.lnbns_de BETWEEN REPLACE(#{srchLnbnsDeBegin}, '-') AND REPLACE(#{srchLnbnsDeEnd}, '-')
		</if>
		<if test="srchLnbnsDeEnd eq null or srchLnbnsDeEnd eq ''">
		   AND t2.lnbns_de = REPLACE(#{srchLnbnsDeBegin}, '-')
		</if>
	</if>
	<if test='srchProcessSttus != null and srchProcessSttus != ""'>
	   AND t1.reqst_sttus_code = #{srchProcessSttus}
	</if>
	<if test='srchProcessSttus == null or srchProcessSttus == ""'>
	   AND t1.reqst_sttus_code in('1','2','3','5')
	</if>
	<if test="srchReqstNo != null and srchReqstNo != ''">
	   AND t2.reqst_id LIKE '%' || #{srchReqstNo} || '%'
	</if>
	<if test="srchNm != null and srchNm != ''">
	   AND t1.nm LIKE '%' || #{srchNm} || '%'
	</if>
	<if test="srchLnbnsTime != null and srchLnbnsTime != ''">
	   AND t2.lnbns_time = #{srchLnbnsTime}
	</if>
	<if test="srchVhcleNum != null and srchVhcleNum != ''">
	   AND t3.vhcle_num = #{srchVhcleNum}
	</if>
	<if test="srchPolice != null and srchPolice != ''">
		<choose>
			<when test='srchPolice.equals("X1")'>
				AND t1.POLICE_IDNTY_INQIRE_RESULT = 'X'
				AND t5.POLICE_IMPROPT_RESN_CD IS NULL
			</when>
			<when test='srchPolice.equals("X2")'>
				AND t1.POLICE_IDNTY_INQIRE_RESULT = 'X'
				AND t5.POLICE_IMPROPT_RESN_CD IS NOT NULL
				AND T5.POLICE_IMPROPT_RESN_CD NOT IN ('3')
			</when>
			<otherwise>
			    AND t1.POLICE_IDNTY_INQIRE_RESULT = 'O'
			</otherwise>
		</choose>
	</if>

	 
    </select>
    
    <!-- 승인번호 체번 -->
    <select id="getConfmNo" resultType="String">
	<![CDATA[
		SELECT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.getconfmNo */
			   CAST(TO_CHAR(SYS_DATE, 'YYYYMMDD') || SR_TBUPREQSTSANCTNPROCESS_01.NEXTVAL AS VARCHAR(12))	   
	]]>
    </select>
    
    
    <!-- 신청 결재 처리 입력 -->
    <insert id="insertReqstSanctnProcess" parameterType="ConfmProcessManageVo">
	<![CDATA[
		INSERT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.insertReqstSanctnProcess */
		  INTO tb_up_reqst_sanctn_process (
			   reqst_id
			 , applcnt_sn
			 , frst_crtr_id
			 , frst_creat_dt
			 , last_updusr_id
			 , last_updt_dt
			 , confm_de
			 , confm_sttus_code
			 , confmer_id
			 , confm_resn_cn
			 , delete_at
			 , confm_no
			 )
		VALUES (
			   #{reqstId}
			 , #{applcntSn}
			 , #{userId}
			 , SYS_DATETIME
			 , #{userId}
			 , SYS_DATETIME
			 , TO_CHAR(SYS_DATETIME, 'YYYYMMDDHH24MISS')
			 , #{newProcessSttus}
			 , #{userId}
			 , #{processPrvonsh}
			 , 'N'
			 , #{confmNo}
		)
	]]>
    </insert>
    
    <!-- 신청 인적 사항 승인 처리 -->
    <update id="updateReqstHnMatterToReqstSttusCode" parameterType="ConfmProcessManageVo">
	<![CDATA[
		UPDATE tb_up_reqst_hn_matter /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.updateReqstHnMatterToReqstSttusCode */
		   SET last_updusr_id  	= #{userId}
		     , last_updt_dt   	= SYS_DATETIME
		     , reqst_sttus_code = #{newProcessSttus}
		     , confm_de			= TO_CHAR(SYS_DATETIME, 'YYYYMMDDHH24MISS')
		     , confmer_id		= #{userId}
		     , confm_resn_cn	= #{processPrvonsh}
		     , confm_no 		= #{confmNo}
		 WHERE reqst_id 		= #{reqstId}
		   AND applcnt_sn 		= #{applcntSn}
	]]>
    </update>
   
    <!-- 견학 신청자 이력 입력 -->
	<insert id="insertReqstHnMatterHist" parameterType="ConfmProcessManageVo" >
	<![CDATA[
		INSERT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.insertReqstHnMatterHist */
		  INTO tb_up_reqst_hn_matter_hist(
				hist_id
			 , frst_crtr_id
			 , frst_creat_dt
			 , last_updusr_id
			 , last_updt_dt
			 , reqst_id
			 , applcnt_sn
			 , lnbns_schdul_id
			 , vhcle_id
			 , native_se_code
			 , nation_code
			 , nm
			 , ihidnum
			 , brthdy
			 , sexdstn
			 , zip
			 , adres
			 , detail_adres
			 , mbtlnum
			 , psprnbr
			 , pasport_valid_begin_de
			 , pasport_valid_end_de
			 , indvdl_info_use_agre_at
			 , sms_recptn_agre_at
			 , file_atch_agre_at
			 , self_reqst_at
			 , reqst_de
			 , confm_de
			 , confmer_id
			 , confm_resn_cn
			 , reqst_sttus_code
			 , delete_at
			 , lnbns_man_ty_code
			 , clss_nd_ofcps
			 , lnbns_de
			 , confm_no
		  )
		SELECT sr_tbupreqsthnmatterhist_01.nextval
			 , #{userId}
			 , frst_creat_dt
			 , #{userId}
			 , last_updt_dt
			 , reqst_id
			 , applcnt_sn
			 , lnbns_schdul_id
			 , vhcle_id
			 , native_se_code
			 , nation_code
			 , nm
			 , ihidnum
			 , brthdy
			 , sexdstn
			 , zip
			 , adres
			 , detail_adres
			 , mbtlnum
			 , psprnbr
			 , pasport_valid_begin_de
			 , pasport_valid_end_de
			 , indvdl_info_use_agre_at
			 , sms_recptn_agre_at
			 , file_atch_agre_at
			 , self_reqst_at
			 , reqst_de
			 , confm_de
			 , confmer_id
			 , confm_resn_cn
			 , reqst_sttus_code
			 , delete_at
			 , lnbns_man_ty_code
			 , clss_nd_ofcps
			 , lnbns_de
			 , confm_no
		  FROM tb_up_reqst_hn_matter
		 WHERE reqst_id = #{reqstId}
	]]>		 
		<if test="applcntSn != null">
		   AND applcnt_sn = #{applcntSn}
		</if>

	</insert>
    
    <!-- 신청 정보 승인 처리 -->
    <update id="updateReqstInfoToProcessSttus" parameterType="ConfmProcessManageVo">
		 MERGE /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.updateReqstInfoToProcessSttus */
		  INTO tb_up_reqst_info AS tgt
		 USING (
				 SELECT reqst_id
				      , sum(CASE WHEN reqst_sttus_code = '1' THEN 1 ELSE 0 END) AS applcnt_cnt 
				      , #{confmNo} AS confm_no
				      , #{processPrvonsh} AS process_prvonsh
				      , CASE WHEN sum(CASE WHEN reqst_sttus_code = '2' THEN 1 ELSE 0 END) > 0 THEN '2' ELSE #{newProcessSttus} END AS process_sttus
				      , sum(CASE WHEN reqst_sttus_code = '2' THEN 1 ELSE 0 END) AS new_lnbns_nmpr_co
				   FROM tb_up_reqst_hn_matter 
				  WHERE reqst_id = #{reqstId}
				    AND delete_at = 'N'
				  GROUP BY reqst_id 
		 	 ) AS src
		    ON (tgt.reqst_id=src.reqst_id AND src.applcnt_cnt = 0)
		  WHEN MATCHED THEN 
		UPDATE 
		   SET tgt.last_updusr_id  = #{userId}
		     , tgt.last_updt_dt    = SYS_DATETIME
		     , tgt.process_sttus   = src.process_sttus
		     , tgt.process_dt      = SYS_DATETIME
		     , tgt.process_prvonsh = src.process_prvonsh
		     , tgt.confm_no        = src.confm_no
			 , tgt.opetr_id        = #{userId}
			 , tgt.lnbns_nmpr_co   = src.new_lnbns_nmpr_co
    </update>
    
    <!-- 견학 신청 처리 이력 입력 -->
	<insert id="insertReqstProcessHist" parameterType="ConfmProcessManageVo" >
	<![CDATA[
		INSERT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.insertReqstProcessHist */
		  INTO tb_up_reqst_process_hist(
		       doc_process_hist_sn
		     , frst_crtr_id
		     , frst_creat_dt
		     , last_updusr_id
		     , last_updt_dt
		     , lnbns_schdul_id
		     , applcnt_id
		     , reqst_de
		     , lnbns_de
		     , reqst_sttus_code
		     , valid_begin_de
		     , valid_end_de
		     , delete_at
		     , opetr_id
		     , process_sttus
		     , lnbns_nmpr_co
		     , process_dt
		     , rm
		     , reqst_id
		     , lnbns_time_odr
		  	 , lnbns_time
		  	 , confm_no)
		SELECT sr_tbupreqstprocesshist_01.nextval
		     , #{userId}
		     , frst_creat_dt
		     , #{userId}
		     , last_updt_dt
		     , lnbns_schdul_id
		     , applcnt_id
		     , reqst_de
		     , lnbns_de
		     , reqst_sttus_code
		     , valid_begin_de
		     , valid_end_de
		     , delete_at
		     , opetr_id
		     , process_sttus
		     , lnbns_nmpr_co
		     , SYS_DATETIME
		     , #{processPrvonsh}
		     , reqst_id
		     , lnbns_time_odr
		  	 , lnbns_time
		  	 , confm_no
		  FROM tb_up_reqst_info
		 WHERE reqst_id = #{reqstId}
	]]>
    </insert>
    
    <!-- 견학 인원 목록 출력 -->
    <select id="selectListLnbnsNmprOutpt" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
		SELECT /* SQL ID : KR.GO.PMIS.SCHEDMGMT.CONFMPROCESS.DAO.CONFMPROCESSMANAGEDAO.SELECTLISTLNBNSNMPROUTPT */
		       ORDERBY_NUM() AS lnbnsNo
			 , T1.LNBNS_SE_CODE
			 , (SELECT SMALL_CL_CODE_NM FROM TB_AE_CMMN_CODE_CL WHERE LRGE_CL_CODE = 'P006' AND SMALL_CL_CODE = T1.LNBNS_SE_CODE) AS LNBNS_SE_CODE_NM /* 견학 구분 명 */     
			 , T1.REQST_DE
		     , T1.LNBNS_DE
		     , T1.LNBNS_TIME_ODR
		     , T5.RM AS LNBNS_TIME<!-- UNC등 제공용 문서에는 원래 견학시간 ex)1500 홈페이지 표출 견학 시간 ex)1410 -->
		     , T2.NM
		     , T2.MBTLNUM
		     , T2.BRTHDY
		     , T2.ADRES ||', '|| T2.DETAIL_ADRES AS adres
		     , T2.SEXDSTN
		     , (SELECT SMALL_CL_CODE_NM FROM TB_AE_CMMN_CODE_CL WHERE LRGE_CL_CODE = 'P008' AND SMALL_CL_CODE = T2.SEXDSTN) AS sexdstn_nm /* 성별 명 */
		     , T2.CONFM_NO
		     , T2.LNBNS_EXECUT_AT /* 견학 실행 여부 */
		     , T3.VHCLE_ODR
		     , T1.REQST_ID
		     , TO_CHAR(TO_DATETIME(T1.LNBNS_DE || T1.LNBNS_TIME || '00','YYYYMMDDHH24MISS'),'YYYY. MM. DD. HH24:MI') as lnbns_dt
		     , NVL(T1.SHUTTLE_BUS_BRDNG_AT,'N') AS shuttleBusBrdngAt
		  FROM TB_UP_REQST_INFO T1
		 INNER 
		  JOIN TB_UP_REQST_HN_MATTER T2
		    ON T1.REQST_ID = T2.REQST_ID  
		 <choose>
		 	<when test="srchApplication != null and srchApplication != ''">
		 		AND T2.REQST_STTUS_CODE IN('1', '2')
		 	</when>
		 	<otherwise>
		 		AND T2.REQST_STTUS_CODE IN('2')
		 	</otherwise>
		 </choose>
		   AND T2.DELETE_AT = 'N'
		 INNER
		  JOIN TB_UP_LNBNS_VHCLE_INFO T3
		    ON T1.LNBNS_SCHDUL_ID = T3.LNBNS_SCHDUL_ID
		   AND T2.VHCLE_ID = T3.VHCLE_ID
		   AND T3.DELETE_AT = 'N'
		 INNER
		  JOIN TB_UP_LNBNS_SCHDUL_INFO T4
		    ON T1.LNBNS_SCHDUL_ID = T4.LNBNS_SCHDUL_ID
		   AND T4.DELETE_AT = 'N'
		 INNER
		  JOIN TB_UP_ENV_SETUP_INFO T5
		    ON T5.ENV_SETUP_CODE = T4.LNBNS_TIME_CODE 
		   AND T5.STDR_CODE = 'SYS011' 
           AND T5.SE_CODE = 'LTM'  
		 WHERE T1.REQST_STTUS_CODE = '1'
		   AND T1.DELETE_AT = 'N'
		 <!-- 불허 처리를 하지 않아 누락 건이 발생하여 주석 처리 -->
		   AND T1.PROCESS_STTUS IN( '1', '2' )
		   <!---->
	<if test="srchReqstDeBegin != null and srchReqstDeBegin != ''">
		<if test="srchReqstDeEnd != null and srchReqstDeEnd != ''">
		   AND T1.REQST_DE BETWEEN REPLACE(#{srchReqstDeBegin}, '-') AND REPLACE(#{srchReqstDeEnd}, '-')
		</if>
		<if test="srchReqstDeEnd eq null or srchReqstDeEnd eq ''">
		   AND T1.REQST_DE = REPLACE(#{srchReqstDeBegin}, '-')
		</if>
	</if> 
	<if test="srchLnbnsDeBegin != null and srchLnbnsDeBegin != ''">
		<if test="srchLnbnsDeEnd != null and srchLnbnsDeEnd != ''">
		   AND T1.LNBNS_DE BETWEEN REPLACE(#{srchLnbnsDeBegin}, '-') AND REPLACE(#{srchLnbnsDeEnd}, '-')
		</if>
		<if test="srchLnbnsDeEnd eq null or srchLnbnsDeEnd eq ''">
		   AND T1.LNBNS_DE = REPLACE(#{srchLnbnsDeBegin}, '-')
		</if>
	</if>	 
	<if test="srchLnbnsTime != null and srchLnbnsTime != ''">
		  AND T1.LNBNS_TIME = #{srchLnbnsTime}
	</if>
	<if test="srchVhcleNum != null and srchVhcleNum != ''">
	   AND T3.VHCLE_ODR = #{srchVhcleNum}
	</if>
	   ORDER BY T1.LNBNS_TIME ASC, T1.LNBNS_DE ASC, T3.VHCLE_ODR ASC, T1.REQST_ID ASC, T2.NM ASC
	        FOR ORDERBY_NUM()
    </select>
    
    <!-- 파일 다운로드 입력 -->
    <insert id="insertFileDwldLog" parameterType="ConfmProcessManageVo">
        <selectKey resultType="string" keyProperty="histSn" order="BEFORE">
            SELECT sr_tbupfiledwldlog_01.nextval
        </selectKey>
		INSERT /* SQL ID : ConfmProcessManageDao.insertFileDwldLog */
		  INTO tb_up_file_dwld_log (
		  	   hist_sn
		  	 , frst_crtr_id
		  	 , frst_creat_dt
		  	 , last_updusr_id
		  	 , last_updt_dt
		  	 , file_nm
		  	 , menu_no
		  	 , lots_of_dwld
		  	 , unauthorized_dwld
		  	 , frequent_dwld
		  	 , dwld_reason
		  	 , dwld_cnt)
		VALUES (
			   #{histSn}
		  	 , #{userId}
			 , SYS_DATETIME
			 , #{userId}
			 , SYS_DATETIME
		  	 , #{fileNm}
		  	 , #{menuNo}
		  	 , #{massage1}
		  	 , #{massage2}
		  	 , #{massage3}
		  	 , #{dwldReason}
		  	 , #{dwldCnt})
    </insert>
    <!-- 파일 다운로드 입력 -->
    <insert id="insertFileDwldDtlLogByConfmNo" parameterType="ConfmProcessManageVo">
        INSERT /* SQL ID : ConfmProcessManageDao.insertFileDwldDtlLog */
          INTO tb_up_file_dwld_dtl_log (
               hist_dtl_sn
             , frst_crtr_id
             , frst_creat_dt
             , last_updusr_id
             , last_updt_dt
             , confm_no
             , idnty_inqire_sn
             , hist_sn)
        SELECT sr_tbupfiledwlddtllog_01.nextval as hist_dtl_sn
             , #{userId} as frst_crtr_id
             , SYS_DATETIME as frst_creat_dt
             , #{userId} as last_updusr_id
             , SYS_DATETIME as last_updt_dt
             , t2.confm_no
             , '' as idnty_inqire_sn
             , #{histSn} hist_sn 
          FROM tb_up_reqst_info t1
         INNER 
          JOIN tb_up_reqst_hn_matter t2
            ON t1.reqst_id = t2.reqst_id
           AND t2.reqst_sttus_code = '2'
         INNER
          JOIN tb_up_lnbns_vhcle_info t3
            ON t1.lnbns_schdul_id = t3.lnbns_schdul_id
           AND t2.vhcle_id = t3.vhcle_id
         WHERE t1.reqst_sttus_code = '1'
           AND t1.process_sttus = '2'
    <if test="srchReqstDeBegin != null and srchReqstDeBegin != ''">
        <if test="srchReqstDeEnd != null and srchReqstDeEnd != ''">
           AND t1.reqst_de BETWEEN REPLACE(#{srchReqstDeBegin}, '-') AND REPLACE(#{srchReqstDeEnd}, '-')
        </if>
        <if test="srchReqstDeEnd eq null or srchReqstDeEnd eq ''">
           AND t1.reqst_de = REPLACE(#{srchReqstDeBegin}, '-')
        </if>
    </if>
    <if test="srchLnbnsDeBegin != null and srchLnbnsDeBegin != ''">
        <if test="srchLnbnsDeEnd != null and srchLnbnsDeEnd != ''">
           AND t1.lnbns_de BETWEEN REPLACE(#{srchLnbnsDeBegin}, '-') AND REPLACE(#{srchLnbnsDeEnd}, '-')
        </if>
        <if test="srchLnbnsDeEnd eq null or srchLnbnsDeEnd eq ''">
           AND t1.lnbns_de = REPLACE(#{srchLnbnsDeBegin}, '-')
        </if>
    </if>
    </insert>
    <!-- 견학 신청자 승인처리 문자 발송 -->
	<insert id="insertMssageTrnsmisInfo" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertMssageTrnsmisInfo */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[ 판문점 견학지원센터 처리 안내 ]%0A'
		     || t1.nm || ' 님의  판문점 견학이 ' || #{cn} || '%0A'
		     || '■ 견학 일정 - ' || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분%0A'
             || '■ 견학 차량 - ' || (SELECT vhcle_odr FROM tb_up_lnbns_vhcle_info WHERE lnbns_schdul_id = t2.lnbns_schdul_id AND vhcle_id = t1.vhcle_id) || '호차%0A'
             || '■ 문의처 - 판문점 견학지원센터(1588-8889)%0A'
             || '■ 홈페이지 - https://www.panmuntour.go.kr' AS CN
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '2' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
    <!-- 견학 신청자 확정 문자 발송 DCSM - DECISION -->
	<insert id="insertDcsmMssageTrnsmisInfo" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertDcsmMssageTrnsmisInfo */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[판문점견학지원센터 처리 안내]%0A'
			 || t1.nm || ' 님이 신청하신 판문점 견학이 확정되어 알려드립니다.%0A'
			 || '■ 견학일정 - ' || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분%0A'
			 || '■ 집 결 지 - 임진각 판문점견학지원센터%0A'
		     || '   * 홈페이지 찾아오시는 길 참조%0A'
		     || '■ 집결시간 - 견학시간 50분전까지(시간 준수 요망)%0A'
		     || '   * 집결시간 전까지 미도착시 견학에 참여할 수 없습니다.%0A' 
		     || '■ 신원확인을 위해 주민등록증, 운전면허증, 여권 등 신분증을 반드시 지참%0A'
   		     || '   * 미성년자의 경우 사진이 들어가 있는 학생증, 청소년증, 학교생활기록부, 여권 등 대체 가능%0A'  
		     || '■ 문 의 처 - 판문점견학지원센터(1588-8889)%0A'
		     || '■ 홈페이지 - https://www.panmuntour.go.kr%0A'
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '8' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
	
	<!-- 견학 신청자 확정 문자 발송 202106 견학 건 부터  DCSM - DECISION -->
	<insert id="insertDcsmMssageTrnsmisInfo2" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertDcsmMssageTrnsmisInfo2 */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[판문점견학지원센터 처리 안내]%0A'
			 || t1.nm || ' 님이 신청하신 판문점 견학이 확정되어 알려드립니다.%0A'
			 || '■ 견학일정 - ' || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분%0A'
			 || '■ 집 결 지 - 임진각 판문점견학지원센터%0A'
		     || '   * 홈페이지 찾아오시는 길 참조%0A'
		     || '■ 집결시간 - 견학시간 전까지(시간 준수 요망)%0A'
		     || '   * 집결시간 전까지 미도착시 견학에 참여할 수 없습니다.%0A' 
		     || '■ 신원확인을 위해 주민등록증, 운전면허증, 여권 등 신분증을 반드시 지참%0A'
   		     || '   * 미성년자의 경우 사진이 들어가 있는 학생증, 청소년증, 학교생활기록부, 여권 등 대체 가능%0A'  
		     || '■ 문 의 처 - 판문점견학지원센터(1588-8889)%0A'
		     || '■ 홈페이지 - https://www.panmuntour.go.kr%0A'
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '17' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
	
	<!-- 확정 메시지 변경 20211129 -->
	<insert id="insertDcsmMssageTrnsmisInfo3" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertDcsmMssageTrnsmisInfo3 */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[판문점견학지원센터 처리 안내]%0A'
			 || t1.nm || ' 님이 신청하신 판문점 견학이 확정되어 알려드립니다.%0A'
			 || '■ 견학일정 - ' || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분%0A'
			 || '■ 집 결 지 - 임진각 판문점견학지원센터%0A'
		     || '   * 홈페이지 찾아오시는 길 참조%0A'
		     || '■ 집결시간 - 견학시간 전까지(시간 준수 요망)%0A'
		     || '   * 집결시간 전까지 미도착시 견학에 참여할 수 없습니다.%0A' 
		     || '■ 신원확인을 위해 주민등록증, 운전면허증, 여권 등 신분증을 반드시 지참%0A'
   		     || '   * 미성년자의 경우 사진이 들어가 있는 학생증, 청소년증, 학교생활기록부, 여권 등 대체 가능%0A' 
   		     <!-- || '■ 코로나19 관련 방문제한 안내%0A'
   		     || '   * 방문일 기준 코로나 백신 접종 완료 후 14일 경과 또는 방문일 기준 3일 전 이내 코로나19 PCR 검사 후 음성판정을 받는 분께서만 출입이 가능%0A'
   		     || '   * 방문시에는 백신 접종 완료 확인서(전차출입명부QR코드가능) 또는 음성 판정 확인서를 반드시 지참%0A'
   		     || '※ 미성년자도 동일%0A' -->
		     || '■ 문 의 처 - 판문점견학지원센터(1588-8889)%0A'
		     || '■ 홈페이지 - https://www.panmuntour.go.kr%0A'
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '21' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
	<!-- 견학 신청자 확정 문자 발송 20220701 셔틀버스 안내 추가-->
	<insert id="insertDcsmMssageTrnsmisInfo4" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertDcsmMssageTrnsmisInfo4 */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[판문점견학지원센터 처리 안내]%0A'
			 || t1.nm || ' 님이 신청하신 판문점 견학이 확정되어 알려드립니다.%0A'
			 || '■ 견학일정 - ' || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분%0A'
			 || '■ 집 결 지 - 임진각 판문점견학지원센터%0A'
		     || '   * 홈페이지 찾아오시는 길 참조%0A'
		     || '■ 집결시간 - 견학시간 전까지(시간 준수 요망)%0A'
		     || '   * 집결시간 전까지 미도착시 견학에 참여할 수 없습니다.%0A' 
		     || '■ 신원확인을 위해 주민등록증, 운전면허증, 여권 등 신분증을 반드시 지참%0A'
   		     || '   * 미성년자의 경우 사진이 들어가 있는 학생증, 청소년증, 학교생활기록부, 여권 등 대체 가능%0A'  
		     || '■ 문 의 처 - 판문점견학지원센터(1588-8889)%0A'
		     || '■ 홈페이지 - https://www.panmuntour.go.kr%0A'
		     || '■ 셔틀버스 이용안내%0A'
		     || '- 13:50 문산역 1번 출구 -> 판문점견학안내소%0A'
		     || '- 16:50 (견학 종료 후)판문점견학안내소 -> 임진강역%0A'
		     || '* 셔틀버스 이용하실 분은 판문점견학지원센터(1588-8889)로 반드시 사전 신청해주시기 바랍니다.%0A'
		     || '(신청자가 없을 경우 미운행)'
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '22' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
	<!-- 견학 신청자 확정 문자 발송 20220902 셔틀버스 안내 변경 및 구간정보 변경 추가-->
	<insert id="insertDcsmMssageTrnsmisInfo5" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertDcsmMssageTrnsmisInfo4 */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[판문점견학지원센터 처리 안내]%0A'
			 || t1.nm || ' 님이 신청하신 판문점 견학이 확정되어 알려드립니다.%0A'
			 || '■ 견학일정 - ' || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분%0A'
			 || '■ 집 결 지 - 임진각 판문점견학지원센터%0A'
		     || '   * 홈페이지 찾아오시는 길 참조%0A'
		     || '■ 집결시간 - 견학시간 전까지(시간 준수 요망)%0A'
		     || '   * 집결시간 전까지 미도착시 견학에 참여할 수 없습니다.%0A' 
		     || '■ 신원확인을 위해 주민등록증, 운전면허증, 여권 등 신분증을 반드시 지참%0A'
   		     || '   * 미성년자의 경우 사진이 들어가 있는 학생증, 청소년증, 학교생활기록부, 여권 등 대체 가능%0A'  
		     || '■ 문 의 처 - 판문점견학지원센터(1588-8889)%0A'
		     || '■ 홈페이지 - https://www.panmuntour.go.kr%0A'
		     || '■ 셔틀버스 이용안내%0A'
		     || '- 13:50 문산역 1번 출구 -> 판문점견학안내소%0A'
		     || '- 16:50 (견학 종료 후)판문점견학안내소 -> 문산역%0A'
		     || '* 셔틀버스 이용하실 분은 홈페이지 견학 신청서의 셔틀 버스 이용 여부를 통해 반드시 사전 신청해주시기 바랍니다.%0A'
		     || '(신청자가 없을 경우 미운행)'
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '24' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
	<!-- 견학 신청자 불허처리 문자 발송 NNPMSN - NONPERMISSION -->
	<insert id="insertNnpmsnMssageTrnsmisInfo" parameterType="ConfmProcessManageVo" >
		INSERT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.insertNnpmsnMssageTrnsmisInfo */
		  INTO TB_UP_MSSAGE_TRNSMIS_INFO (
			   MSSAGE_SN
			 , FRST_CRTR_ID	
			 , FRST_CREAT_DT	
			 , LAST_UPDUSR_ID	
			 , LAST_UPDT_DT	
			 , TRNSMIS_SE
			 , SJ
			 , CN
			 , SENDER_TELNO
			 , RCVER_TELNO	
			 , TRNSMIS_STTUS
			 , SNDNG_REQUST_DT
			 , TMPLAT_CODE
			  )
		SELECT sr_tbupmssagetrnsmisinfo_01.nextval AS MSSAGE_SN
		     , #{userId} AS FRST_CRTR_ID
		     , SYS_DATETIME AS FRST_CREAT_DT
		     , #{userId} AS LAST_UPDUSR_ID
		     , SYS_DATETIME AS LAST_UPDT_DT
		     , 'alimtalk' AS TRNSMIS_SE
		     , #{sj} AS SJ
		     , '[ 판문점 견학지원센터 처리 안내 ]%0A'
		     || t1.nm || ' 님이 신청하신 '
		     || substr(t2.lnbns_de, 1, 4) || '년 ' || substr(t2.lnbns_de, 5, 2) || '월 ' || substr(t2.lnbns_de, 7, 2) || '일 ' || substr(t2.lnbns_time, 1, 2) || '시 ' || substr(t2.lnbns_time, 3, 2) || '분 '
             || '판문점 견학이 신원확인 결과 부득이 어렵게 되었음을 알려드립니다.%0A'
             || '■ 문의처 - 판문점 견학지원센터(1588-8889)%0A'
             || '■ 홈페이지 - https://www.panmuntour.go.kr' AS CN
		     , '1588-8889' AS SENDER_TELNO
		     , t1.mbtlnum AS RCVER_TELNO
		     , 'N' AS TRNSMIS_STTUS
		     , SYSDATETIME AS SNDNG_REQUST_DT
		     , '9' AS TMPLAT_CODE
		  FROM tb_up_reqst_hn_matter t1
		 INNER 
		  JOIN tb_up_reqst_info t2
		    ON t1.reqst_id = t2.reqst_id
		   AND t2.reqst_sttus_code = '1'
		 WHERE t1.reqst_id = #{reqstId}
		   AND t1.applcnt_sn = #{applcntSn}
	</insert>
    <select id="selectListExmplLnbns" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
		 SELECT
			REQST_ID,
			NM,
			BRTHDY,
			ZIP,
			ADRES,
			DETAIL_ADRES,
			MBTLNUM,
			LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
		FROM
			TB_UP_EXMPL_HN_MATTER
			WHERE 1=1
		<if test="srchLnbnsTimeOdr != null and srchLnbnsTimeOdr != ''">
			  AND LNBNS_TIME_ODR = #{srchLnbnsTimeOdr}
		</if>
		<if test="srchNm != null and srchNm != ''">
			  AND NM = #{srchNm}
		</if>
    </select>
    
    <select id="selectListExmplLnbnsDrwt" resultType="ConfmProcessManageVo">
				
		SELECT S.*
		FROM (
			SELECT A.*
			FROM (
			 SELECT
				NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
			FROM
				TB_UP_EXMPL_HN_MATTER
			WHERE
			<![CDATA[
			TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)>18
			AND TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)<30
			AND LNBNS_TIME_ODR = '1'
			GROUP BY NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR
			ORDER BY RANDOM()
			)A
			WHERE ROWNUM < 5
			]]>
			
			UNION ALL
			
			SELECT B.*
			FROM (
			 SELECT
				NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
			FROM
				TB_UP_EXMPL_HN_MATTER
			WHERE
			<![CDATA[
			TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)>29
			AND TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)<40
			AND LNBNS_TIME_ODR = '1'
			GROUP BY NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR
			ORDER BY RANDOM()
			)B
			WHERE ROWNUM < 5
			]]>
			
			UNION ALL
			
			SELECT C.*
			FROM (
			 SELECT
				NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
			FROM
				TB_UP_EXMPL_HN_MATTER
			WHERE
			<![CDATA[
			TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)>39
			AND TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)<50
			AND LNBNS_TIME_ODR = '1'
			GROUP BY NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR
			ORDER BY RANDOM()
			)C
			WHERE ROWNUM < 5
			]]>
			
			UNION ALL
			
			SELECT D.*
			FROM (
			 SELECT
				NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
			FROM
				TB_UP_EXMPL_HN_MATTER
			WHERE
			<![CDATA[
			TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)>49
			AND TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)<60
			AND LNBNS_TIME_ODR = '1'
			GROUP BY NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR
			ORDER BY RANDOM()
			)D
			WHERE ROWNUM < 5
			]]>
			
			UNION ALL
			
			SELECT E.*
			FROM (
			 SELECT
				NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
			FROM
				TB_UP_EXMPL_HN_MATTER
			WHERE
			<![CDATA[
			TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), TO_DATE(SUBSTR(BRTHDY,1,4),'YYYY'))/12)>59
			AND LNBNS_TIME_ODR = '1'
			GROUP BY NM,
				BRTHDY,
				MBTLNUM,
				LNBNS_TIME_ODR
			ORDER BY RANDOM()
			)E
			WHERE ROWNUM < 5
			]]>
		)S
    </select>
    
    <select id="selectListExmplLnbnsDrwt2" resultType="ConfmProcessManageVo">
		SELECT E.*
		FROM (	
			SELECT
				REQST_ID,
				NM,
				BRTHDY,
				ZIP,
				ADRES,
				DETAIL_ADRES,
				MBTLNUM,
				LNBNS_TIME_ODR || '회차' as lnbnsTimeOdr
			FROM
				TB_UP_EXMPL_HN_MATTER
			WHERE
		<![CDATA[
			LNBNS_TIME_ODR = '2'
			ORDER BY RANDOM()
		) E
		WHERE ROWNUM < 31
		]]>
    </select>
    
    <!-- 견학 건 목록 출력 -->
    <select id="selectListLnbnsNmprUpdate" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
    <![CDATA[
			SELECT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.selectListLnbnsNmprUpdate */
				A.REQST_ID,
				A.LNBNS_SCHDUL_ID,
				A.APPLCNT_ID,
				A.REQST_DE,
				TO_CHAR(A.CANCL_DT, 'YYYY-MM-DD') AS cancl_dt, /* 처리일자 */
				A.PROCESS_STTUS, /* 처리상태코드 */
				A.LNBNS_DE,
				A.LNBNS_TIME,
				A.LNBNS_NMPR_CO,
				A.CANCL_PRVONSH,
				( SELECT GROUP_CONCAT(B.NM SEPARATOR ', ') 
					FROM tb_up_reqst_hn_matter C
					WHERE A.REQST_ID = C.REQST_ID
					AND C.DELETE_AT = 'N'
					AND A.LNBNS_SCHDUL_ID = C.LNBNS_SCHDUL_ID
					AND A.REQST_DE = C.REQST_DE) AS listNm,
				A.SHUTTLE_BUS_BRDNG_AT
			FROM 
				TB_UP_REQST_INFO A 
					INNER 
					JOIN tb_up_reqst_hn_matter B
					  ON A.reqst_id = B.reqst_id AND A.LNBNS_SCHDUL_ID = B.LNBNS_SCHDUL_ID
					 	WHERE B.DELETE_AT = 'N'
				]]>
							<choose>
							 <when test="processSttus != null and processSttus != '' ">
							 	AND  A.PROCESS_STTUS = #{processSttus}	
							 </when>
							 <otherwise>
							 	AND  A.PROCESS_STTUS in('1', '2')
							 </otherwise>
							</choose>						 
							 
							 AND  A.DELETE_AT = 'N'
							 AND A.REQST_STTUS_CODE = '1'
			<if test="srchReqstDeBegin != null and srchReqstDeBegin != ''">
				<if test="srchReqstDeEnd != null and srchReqstDeEnd != ''">
				   AND A.REQST_DE BETWEEN REPLACE(#{srchReqstDeBegin}, '-') AND REPLACE(#{srchReqstDeEnd}, '-')
				</if>
				<if test="srchReqstDeEnd eq null or srchReqstDeEnd eq ''">
				   AND A.REQST_DE = REPLACE(#{srchReqstDeBegin}, '-')
				</if>
			</if> 
			<if test="srchLnbnsDeBegin != null and srchLnbnsDeBegin != ''">
				<if test="srchLnbnsDeEnd != null and srchLnbnsDeEnd != ''">
				   AND A.LNBNS_DE BETWEEN REPLACE(#{srchLnbnsDeBegin}, '-') AND REPLACE(#{srchLnbnsDeEnd}, '-')
				</if>
				<if test="srchLnbnsDeEnd eq null or srchLnbnsDeEnd eq ''">
				   AND A.LNBNS_DE = REPLACE(#{srchLnbnsDeBegin}, '-')
				</if>
			</if>	 
			<if test="srchLnbnsTime != null and srchLnbnsTime != ''">
				  AND A.LNBNS_TIME = #{srchLnbnsTime}
			</if>
			<if test="srchNm != null and srchNm != ''">
				  AND A.reqst_id = (SELECT REQST_ID FROM tb_up_reqst_hn_matter WHERE NM = #{srchNm} AND REQST_STTUS_CODE IN ('1','2') AND DELETE_AT='N' AND A.REQST_ID = REQST_ID)
			</if>
				GROUP BY A.REQST_ID
				ORDER BY A.REQST_ID			
    </select>
    
    <!-- 견학 인원 상세보기 출력 -->
    <select id="LnbnsNmprDetailList" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
	    	SELECT  /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.LnbnsNmprDetailList */
				A.REQST_ID,
				A.LNBNS_SCHDUL_ID,
				(SELECT LNBNS_TIME FROM TB_UP_REQST_INFO WHERE REQST_ID = A.REQST_ID) LNBNS_TIME,
				A.REQST_DE,
				A.LNBNS_DE,
				A.NM,
				A.MBTLNUM,
				A.ADRES,
				A.DETAIL_ADRES,
				A.ZIP,
				(SELECT B.VHCLE_ODR FROM TB_UP_LNBNS_VHCLE_INFO B  WHERE A.LNBNS_SCHDUL_ID = B.LNBNS_SCHDUL_ID AND A.VHCLE_ID=B.VHCLE_ID) ||'호차'AS vhcleNum
			FROM 
				TB_UP_REQST_HN_MATTER A
			WHERE 
				A.REQST_ID =  #{reqstId}
				AND A.DELETE_AT = 'N'
				AND A.REQST_STTUS_CODE IN('1', '2')
    </select>
    
     <!-- 견학 건 취소 -->
    <update id="LnbnsUpdate" parameterType="ConfmProcessManageVo">
	    UPDATE	/* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.LnbnsUpdate */
				TB_UP_REQST_HN_MATTER A , TB_UP_REQST_INFO B 
		   SET  B.PROCESS_STTUS = '5'
			  , A.REQST_STTUS_CODE = '5'
			  , A.LAST_UPDT_DT = SYSDATETIME
			  , B.LAST_UPDT_DT = SYSDATETIME
		   	  , B.CANCL_PRVONSH = '[관리자] 삭제 요청'
		   	  , B.CANCL_DT = SYSDATETIME
		 WHERE A.REQST_ID = B.REQST_ID
		   AND B.REQST_ID = #{reqstId}
    	   AND A.DELETE_AT = 'N'
    	   AND B.DELETE_AT = 'N'
    </update>
    
     <!-- 견학 인원 삭제 -->
     <update id="LnbnsNmprDelete" parameterType="ConfmProcessManageVo">
	    UPDATE	 /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.LnbnsNmprDelete */
	    	  	TB_UP_REQST_HN_MATTER
		   SET 
		   		LAST_UPDT_DT = SYSDATETIME
			  , REQST_STTUS_CODE = '5'
		 WHERE REQST_ID = #{reqstId}
		   AND DELETE_AT = 'N'	   
		   AND MBTLNUM = #{mbtlnum}
		   AND NM = #{nm}
    </update>
    
     <!-- 취소된/추가 견학 인원 수 체크 -->
     <update id="LnbnsNmprCoUpdate" parameterType="ConfmProcessManageVo">
	     <selectKey resultType="String" keyProperty="lnbnsNmprCo" order="BEFORE">
            SELECT COUNT(*) 
              FROM TB_UP_REQST_HN_MATTER 
             WHERE DELETE_AT = 'N' 
               AND REQST_STTUS_CODE IN('1', '2')
               AND REQST_ID = #{reqstId}
	     </selectKey>
	     <choose>
		     <when test='lnbnsNmprCo.equals("0")'>
		     	UPDATE TB_UP_REQST_INFO
		     	   SET LAST_UPDT_DT = SYSDATETIME
		     	   	 , REQST_STTUS_CODE = '5'
		     	   	 , PROCESS_STTUS = '5'
		     	   	 , CANCL_PRVONSH = '[관리자] 삭제 요청'
		     	 WHERE REQST_ID = #{reqstId}
		     </when>
			 <otherwise>
			    UPDATE TB_UP_REQST_INFO
				   SET LNBNS_NMPR_CO = #{lnbnsNmprCo}
				 WHERE REQST_ID = #{reqstId}
				   AND DELETE_AT = 'N'		 
			 </otherwise>	     
	     </choose>
    </update>
    
     <!--견학 인원 정보 수정 -->
     <update id="LnbnsNmprUpdate" parameterType="ConfmProcessManageVo">
	    UPDATE	 /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.LnbnsNmprUpdate */
	  		TB_UP_REQST_HN_MATTER
		SET 
			MBTLNUM = #{mbtlnum},
			ADRES =#{adres} ,
			DETAIL_ADRES =#{detailAdres} ,
			ZIP =#{zip} 
		WHERE REQST_ID = #{reqstId}
		AND DELETE_AT = 'N'
		AND NM= #{nm}
   
    </update>
    
    <select id="selectLnbnsVhcleList"  parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
		SELECT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.selectLnbnsVhcleList */
		      A.VHCLE_ID as vhcleIdCk
		    , A.VHCLE_ODR||'호차' AS vhcleOdrCk
		  FROM TB_UP_LNBNS_VHCLE_INFO A 
		 WHERE A.LNBNS_SCHDUL_ID = #{lnbnsSchdulId}
		   AND A.DELETE_AT = 'N'
    </select>
    
    <insert id="LnbnsNmprInsert" parameterType="ConfmProcessManageVo">
		INSERT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.LnbnsNmprInsert */
		  INTO tb_up_reqst_hn_matter (
		       reqst_id
		     , applcnt_sn
		     , frst_crtr_id
		     , frst_creat_dt
		     , last_updusr_id
		     , last_updt_dt
		     , lnbns_schdul_id
		     , vhcle_id
		     , native_se_code
		     , nation_code
		     , nm
		     , ihidnum
		     , brthdy
		     , sexdstn
		     , zip
		     , adres
		     , detail_adres
		     , mbtlnum
		     , psprnbr
		     , pasport_valid_begin_de
		     , pasport_valid_end_de
		     , indvdl_info_use_agre_at
		     , sms_recptn_agre_at
		     , file_atch_agre_at
		     , self_reqst_at
		     , reqst_de
		     , confm_de
		     , confmer_id
		     , confm_resn_cn
		     , reqst_sttus_code
		     , delete_at
		     , lnbns_de
		     , lnbns_execut_at
		     , lnbns_man_ty_code		     
		     , police_trnsmis_sttus_code
		     , issu_at
		     , guidance_mssage_sndng_sttus
		     )
		VALUES (
		       #{reqstId}
		     , CAST(LPAD(sr_tbupreqsthnmatter_01.nextval, 7, '0') AS varchar(7))
		     , #{userId}
		  	 , SYS_DATETIME
		  	 , #{userId}
		  	 , SYS_DATETIME
		     , #{lnbnsSchdulId}
		     , #{vhcleNum}
		     , '1'
		     , 'KR'
		     , #{nm}
		     , MDB_ENC('POLICY001',#{ihidnum})
		     , #{brthdy}
		     , #{sexdstn}
		     , #{zip}
		     , #{adres}
		     , #{detailAdres}
		     , #{mbtlnum}
		     , NUll
		     , NUll
		     , NUll
		     , 'Y'
		     , NUll
		     , NUll
		     , NUll
		     , #{reqstDe}
		     , NUll
		     , NUll
		     , NUll
		     , '1'
		     , 'N'
		     , #{lnbnsDe}
		     , 'N'
		     , '1'		    
		     , 'N'
		     , 'N'
		     , 'N'
		    )
	
    </insert>
    
    <!-- selectListLnbnsExtendTime 페이지 검색 -->
    <select id="selectListLnbnsExtendTime" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
    	SELECT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.selectListLnbnsExtendTime */
				REQST_ID,
				LNBNS_SCHDUL_ID,
				APPLCNT_ID,
				REQST_DE,
				TO_CHAR(CANCL_DT, 'YYYY-MM-DD') AS cancl_dt,
				PROCESS_STTUS,
				LNBNS_DE,
				LNBNS_TIME,
				LNBNS_NMPR_CO,
				SUBSTR(VALID_END_DE, 9, 4) AS validEndDe
			FROM 
				TB_UP_REQST_INFO
				WHERE SUBSTR(VALID_BEGIN_DE, 1, 8) = TO_CHAR(SYSDATETIME,'YYYYMMDD')
				AND PROCESS_STTUS = '0'
				AND SYSDATETIME BETWEEN VALID_BEGIN_DE AND VALID_END_DE
				AND APPLCNT_ID = #{applcntId}
				GROUP BY REQST_ID
				ORDER BY REQST_ID			
    </select>
    
    <!-- 유효기간 연장 UPDATE -->
    <update id="updateLnbnsExtendTime" parameterType="ConfmProcessManageVo">
  			UPDATE TB_UP_REQST_INFO 
  			SET VALID_END_DE = (SELECT TO_CHAR(DATE_ADD(TO_DATETIME(valid_end_de, 'YYYYMMDDHH24MISSFF'), INTERVAL #{extendTime} minute),'YYYYMMDDHH24MISSFF') 
  			FROM tb_up_reqst_info WHERE reqst_id= #{reqstId} AND applcnt_Id = #{applcntId})
			WHERE REQST_ID = #{reqstId} AND APPLCNT_ID = #{applcntId}
    </update>
    
    <select id="selectListLnbns" parameterType="LnbnsSchdulManageVo" resultType="LnbnsSchdulManageVo">
    	SELECT   LSI.LNBNS_SCHDUL_ID
	           , ( SELECT CC.SMALL_CL_CODE_NM 
	                 FROM TB_AE_CMMN_CODE_CL CC
	                 WHERE CC.LRGE_CL_CODE = 'P006' 
	                   AND CC.SMALL_CL_CODE = ENV.STDR_VALUE_SE_CODE ) AS stdrValueSeCodeNm
	           , ENV.STDR_SN||'회차' as stdrSn
	           , SUBSTR(LSI.STDR_DE,1,4)||'-'||SUBSTR(LSI.STDR_DE,5,2)||'-'||SUBSTR(LSI.STDR_DE,7,2) AS stdrDe
	           , SUBSTR(ENV.STDR_VALUE_BEGIN,1,2)||':'||SUBSTR(ENV.STDR_VALUE_BEGIN,3,2) as stdrValueBegin
	           , SUBSTR(ENV.STDR_VALUE_END,1,2)||':'||SUBSTR(ENV.STDR_VALUE_END,3,2) as stdrValueEnd
	           , ( SELECT COUNT(1) 
	                 FROM TB_UP_REQST_INFO RI, TB_UP_REQST_HN_MATTER HM
	                WHERE RI.REQST_ID = HM.REQST_ID
	                  AND RI.PROCESS_STTUS IN ('1','2')
	                  AND HM.REQST_STTUS_CODE IN ('1','2')
	                  AND HM.DELETE_AT = 'N'
		   		      AND RI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID ) AS hnMatterCo
			   , (SELECT IFNULL(SUM(LVI.OPRAT_NMPR_CO) ,'120')
			         FROM TB_UP_LNBNS_VHCLE_INFO LVI
			        WHERE LVI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID  AND LVI.delete_at = 'N' ) AS opratNmprCo
			   , NVL(LSI.caralc_co, 0) AS caralcCo
	      FROM TB_UP_LNBNS_SCHDUL_INFO LSI, TB_UP_ENV_SETUP_INFO ENV, TB_UP_STDR_DE_INFO DE
	     WHERE LSI.LNBNS_TIME_CODE = ENV.ENV_SETUP_CODE
	       AND LSI.DELETE_AT = 'N' 
	       AND ENV.DELETE_AT = 'N'
	       AND LSI.STDR_DE = DE.STDR_DE
		   
	       AND LSI.STDR_DE BETWEEN REPLACE(#{startDay},'-','') AND REPLACE(#{endDay},'-','')
    </select>
    <!-- 신청 ID 조회 -->
	<select id="getReqstId" parameterType="ConfmProcessManageVo" resultType="String">
	<![CDATA[
		SELECT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.getReqstId */
			   sr_tbupreqstinfo_01.nextval
		  FROM db_root
	]]>
	</select>
	
	 <insert id="LnbnsInfoInsert" parameterType="ConfmProcessManageVo">		
		<![CDATA[
		INSERT /* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.ConfmProcessManageDao.LnbnsInfoInsert */
		  INTO tb_up_reqst_info(
		  	   user_sn
		  	 , reqst_id
		  	 , frst_crtr_id
		  	 , frst_creat_dt
		  	 , last_updusr_id
		  	 , last_updt_dt
		  	 , lnbns_schdul_id
		  	 , applcnt_id
		  	 , reqst_de
		  	 , lnbns_de
		  	 , reqst_change_posbl_de 
		  	 , reqst_cancl_posbl_de
		  	 , reqst_sttus_code
		  	 , valid_begin_de
		  	 , valid_end_de
		  	 , delete_at
		  	 , lnbns_nmpr_co
		  	 , lnbns_time_odr
		  	 , lnbns_time
		  	 , lnbns_se_code
		  	 , process_sttus
		  	 )
		VALUES (
			   #{userSn}
		  	 , #{reqstId}
		  	 , #{userId}
		  	 , SYS_DATETIME
		  	 , #{userId}
		  	 , SYS_DATETIME
		  	 , #{lnbnsSchdulId}
		  	 , #{applcntId}
		  	 , TO_CHAR(SYS_DATE, 'YYYYMMDD')
		  	 , #{lnbnsDe}
		  	 , (SELECT TO_CHAR(SUBDATE(TO_DATE(#{lnbnsDe}, 'YYYYMMDD'), st1.stdr_value), 'YYYYMMDD') FROM tb_up_env_setup_info st1 WHERE st1.env_setup_code = 'STD000002')
		  	 , (SELECT TO_CHAR(SUBDATE(TO_DATE(#{lnbnsDe}, 'YYYYMMDD'), st1.stdr_value), 'YYYYMMDD') FROM tb_up_env_setup_info st1 WHERE st1.env_setup_code = 'STD000003')
		  	 , '1'
		  	 , TO_CHAR(SYS_DATETIME, 'YYYYMMDDHH24MISSFF')
		  	 , '99991231235959999'
		  	 , 'N'
		  	 , (SELECT COUNT(*) FROM TB_UP_REQST_HN_MATTER WHERE DELETE_AT = 'N' AND REQST_ID = #{reqstId} AND REQST_STTUS_CODE = '1')
		  	 , ( SELECT ROW_NUMBER() OVER(ORDER BY t5.stdr_value) 
				 FROM  tb_up_env_setup_info t5 , tb_up_lnbns_schdul_info t1 
				 WHERE  t1.lnbns_time_code = t5.env_setup_code
				   AND t1.lnbns_schdul_id = #{lnbnsSchdulId}
				   AND t5.delete_at = 'N'
				   AND t1.delete_at = 'N')
		  	 , #{lnbnsTime}
		  	 , (SELECT t2.stdr_value_se_code
				  FROM tb_up_lnbns_schdul_info t1 
				 INNER 
				  JOIN tb_up_env_setup_info t2
				    ON t1.lnbns_time_code = t2.env_setup_code
				   AND t2.delete_at = 'N'
				   AND t1.delete_at = 'N'
				 WHERE t1.lnbns_schdul_id = #{lnbnsSchdulId})
			 , '1')

	]]>
	
    </insert>
    
    <!-- selectListPriorLnbns 페이지 검색 -->
    <select id="selectListPriorLnbns" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
    	SELECT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.selectListPriorLnbns */
				A.LNBNS_SCHDUL_ID, /* 견학일정 ID */
				A.REQST_ID, /* 신청 번호 */
				A.LNBNS_DE, /* 견학 일자 */
				A.LNBNS_TIME_ODR, /* 견학 회차 */
				A.LNBNS_TIME, /* 견학 시간 */
				B.VHCLE_ID, /* 탑승 차량 */
				B.NM, /* 성명 */
				B.MBTLNUM, /* 전화번호 */
				B.BRTHDY, /* 생년월일 */
				B.SEXDSTN, /* 성별 */
				B.ADRES, /* 주소 */
				B.DETAIL_ADRES, /* 상세주소 */
				B.ZIP, /* 우편번호 */
				B.IHIDNUM, /* 주민번호 */
				A.USER_SN,
				A.APPLCNT_ID
			FROM 
				TB_UP_REQST_INFO A, TB_UP_REQST_HN_MATTER B
				WHERE 1=1
				AND A.REQST_ID = B.REQST_ID
				AND A.REQST_ID = #{reqstId}		
    </select>
    
    <!-- 신청가능한 견학 조회 -->
    <select id="selectLnbnsList"  parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">   
   	       SELECT 
   	       		   LSI.LNBNS_SCHDUL_ID,
				   SUBSTR(LSI.STDR_DE, 3,2)||'년'||SUBSTR(LSI.STDR_DE, 5,2)||'월' || SUBSTR(LSI.STDR_DE, 7,2)|| '일' stdrDe,
				   LSI.STDR_DE stdrTime,
				   SUBSTR(ENV.STDR_VALUE_BEGIN,1,2)||':'||SUBSTR(ENV.STDR_VALUE_BEGIN,3,2) as stdrValueBegin
	       FROM TB_UP_LNBNS_SCHDUL_INFO LSI, TB_UP_ENV_SETUP_INFO ENV, TB_UP_STDR_DE_INFO DE
	       	   WHERE LSI.LNBNS_TIME_CODE = ENV.ENV_SETUP_CODE
	      	  <!--  AND TO_CHAR(TRUNC(((SELECT IFNULL(SUM(LVI.OPRAT_NMPR_CO) ,'120')
			   FROM TB_UP_LNBNS_VHCLE_INFO LVI
			   WHERE LVI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID  AND LVI.delete_at = 'N' ) - ( SELECT COUNT(1) 
	           FROM TB_UP_REQST_INFO RI, TB_UP_REQST_HN_MATTER HM
	           WHERE RI.REQST_ID = HM.REQST_ID
	           AND RI.PROCESS_STTUS IN ('1','2')
	           AND HM.REQST_STTUS_CODE IN ('1','2')
	           AND HM.DELETE_AT = 'N'
	 		   AND RI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID)), 1)) > 0 -->
		       AND LSI.DELETE_AT = 'N' 
		       AND ENV.DELETE_AT = 'N'
		       AND LSI.STDR_DE = DE.STDR_DE
	   	       AND SUBSTR(LSI.LNBNS_SCHDUL_ID, 0, 8) >= TO_CHAR(SYSDATE,'YYYYMMDD')
	   	       AND STDR_VALUE_SE_CODE = '01'
	   	       GROUP BY stdrDe
	   	       ORDER BY stdrDe asc
    </select>
    
    <!-- 신청가능한 견학 조회 -->
    <select id="selectLnbnsList2"  parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">   
   	       SELECT 
		   SUBSTR(ENV.STDR_VALUE_BEGIN,1,2)||':'||SUBSTR(ENV.STDR_VALUE_BEGIN,3,2) as stdrValueBegin
	       FROM TB_UP_LNBNS_SCHDUL_INFO LSI, TB_UP_ENV_SETUP_INFO ENV, TB_UP_STDR_DE_INFO DE
	       WHERE LSI.LNBNS_TIME_CODE = ENV.ENV_SETUP_CODE
	      <!-- AND TO_CHAR(TRUNC(((SELECT IFNULL(SUM(LVI.OPRAT_NMPR_CO) ,'120')
		   FROM TB_UP_LNBNS_VHCLE_INFO LVI
		   WHERE LVI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID  AND LVI.delete_at = 'N' ) - ( SELECT COUNT(1) 
           FROM TB_UP_REQST_INFO RI, TB_UP_REQST_HN_MATTER HM
           WHERE RI.REQST_ID = HM.REQST_ID
           AND RI.PROCESS_STTUS IN ('1','2')
           AND HM.REQST_STTUS_CODE IN ('1','2')
           AND HM.DELETE_AT = 'N'
 		   AND RI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID)), 1)) > 0 -->
	       AND LSI.DELETE_AT = 'N' 
	       AND ENV.DELETE_AT = 'N'
	       AND LSI.STDR_DE = DE.STDR_DE
   	       AND LSI.STDR_DE = #{stdrDe}
   	       AND STDR_VALUE_SE_CODE = '01'
   	       ORDER BY stdrValueBegin asc
    </select>
    
    <!-- 신청가능한 견학 조회 -->
    <select id="selectLnbnsList3"  parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">   
   	       SELECT 
		   SUBSTR(ENV.STDR_VALUE_BEGIN,1,2)||':'||SUBSTR(ENV.STDR_VALUE_BEGIN,3,2) as stdrValueBegin
	       FROM TB_UP_LNBNS_SCHDUL_INFO LSI, TB_UP_ENV_SETUP_INFO ENV, TB_UP_STDR_DE_INFO DE
	       WHERE LSI.LNBNS_TIME_CODE = ENV.ENV_SETUP_CODE
	      AND TO_CHAR(TRUNC(((SELECT IFNULL(SUM(LVI.OPRAT_NMPR_CO) ,'120')
		   FROM TB_UP_LNBNS_VHCLE_INFO LVI
		   WHERE LVI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID  AND LVI.delete_at = 'N' ) - ( SELECT COUNT(1) 
           FROM TB_UP_REQST_INFO RI, TB_UP_REQST_HN_MATTER HM
           WHERE RI.REQST_ID = HM.REQST_ID
           AND RI.PROCESS_STTUS IN ('1','2')
           AND HM.REQST_STTUS_CODE IN ('1','2')
           AND HM.DELETE_AT = 'N'
 		   AND RI.LNBNS_SCHDUL_ID = LSI.LNBNS_SCHDUL_ID)), 1)) > 0
	       AND LSI.DELETE_AT = 'N' 
	       AND ENV.DELETE_AT = 'N'
	       AND LSI.STDR_DE = DE.STDR_DE
   	       AND LSI.STDR_DE = #{stdrDe}
   	       AND STDR_VALUE_SE_CODE = '01'
   	       ORDER BY stdrValueBegin asc
    </select>
   
   <!-- 신청가능한 견학 조회 -->
    <select id="selectReqstHnMatter"  parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">   
		SELECT 
			  A.REQST_ID
			, A.APPLCNT_ID
			, A.LNBNS_NMPR_CO
			, A.LNBNS_DE
			, B.APPLCNT_SN
			, B.LNBNS_SCHDUL_ID
			, NM
			, IHIDNUM
			, SEXDSTN
			, ZIP
			, ADRES
			, DETAIL_ADRES
			, MBTLNUM
			, A.APPLCNT_ID
		FROM TB_UP_REQST_INFO A 
		INNER JOIN TB_UP_REQST_HN_MATTER B 
		ON A.REQST_ID = B.REQST_ID
		WHERE A.REQST_ID = #{reqstId}
		AND B.REQST_STTUS_CODE = '0'
		AND B.DELETE_AT = 'N'
    </select>
    
    <select id="selectFrequentDwld" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
		SELECT frst_crtr_id, file_nm
		FROM tb_up_file_dwld_log 
		WHERE frst_crtr_id = #{userId}
		AND frst_creat_dt BETWEEN DATE_SUB(NOW(), INTERVAL 30 MINUTE) AND NOW()
		AND FILE_NM = #{fileNm}
		GROUP BY frst_crtr_id, file_nm
		HAVING COUNT(*) >= 2
    </select>
    
    <select id="selectProblemPerson" parameterType="ConfmProcessManageVo" resultType="ConfmProcessManageVo">
		SELECT /* SQL ID : kr.go.pmis.web.reqst.dao.ReqstDao.selectProblemPerson */
    		   A.REQST_ID,
			   A.LNBNS_SCHDUL_ID,
			   A.LNBNS_DE,
			   A.NM, 
			   CASE WHEN A.SEXDSTN = 'M' THEN '남자'
			 	    ELSE '여자' END AS SEXDSTN,
			   A.REQST_DE,
			   A.NATION_CODE,
			   A.BRTHDY,
			   A.LNBNS_EXECUT_AT,
			   A.POLICE_IDNTY_INQIRE_RESULT,
			   A.APPLCNT_SN,
			   A.IHIDNUM,
			   B.PROBLEM_REASON,
			   B.FRST_CRTR_ID,
			   B.FRST_CREAT_DT
		FROM tb_up_reqst_hn_matter A
		LEFT OUTER JOIN tb_up_lnbns_problem_info B
		ON A.IHIDNUM = B.IHIDNUM
		WHERE A.NM = #{nm}
		AND A.REQST_STTUS_CODE != '0'
    </select>
    
    <update id="updateProblemPerson" parameterType="ConfmProcessManageVo">
		UPDATE tb_up_lnbns_problem_info
		   SET PROBLEM_REASON = #{problemReason},
			   last_updusr_id = #{loginId},
			   last_updt_dt = sysdatetime
		 WHERE APPLCNT_SN = #{applcntSn}
    </update>
    
    <!-- 견학 신청 처리 이력 입력 -->
	<insert id="insertProblemPerson" parameterType="ConfmProcessManageVo" >
		/* SQL ID : kr.go.pmis.schedmgmt.confmProcess.dao.insertProblemPerson */
		INSERT INTO tb_up_lnbns_problem_info (
		      lnbns_schdul_id,
			  nation_code,
			  nm,
			  ihidnum,
			  sexdstn,
			  mbtlnum,
			  reqst_de,
			  reqst_sttus_code,
			  delete_at,
			  lnbns_execut_at,
			  police_idnty_inqire_result,
			  problem_reason,
			  applcnt_sn,
			  frst_crtr_id,
			  frst_creat_dt
			  )
		SELECT 
			  lnbns_schdul_id,
			  nation_code,
			  nm,
			  ihidnum,
			  sexdstn,
			  mbtlnum,
			  reqst_de,
			  reqst_sttus_code,
			  delete_at,
			  lnbns_execut_at,
			  police_idnty_inqire_result,
			  #{problemReason},
			  applcnt_sn,
			  #{loginId},
			  sysdatetime

		FROM tb_up_reqst_hn_matter
		WHERE nm = #{nm}
		AND ihidnum = #{ihidnum}
    </insert>
    
    <select id="countByName" resultType="Integer">
		SELECT COUNT(*)
		FROM tb_up_lnbns_problem_info
		WHERE ihidnum = #{ihidnum}
		AND nm = #{nm}
		AND APPLCNT_SN = #{applcntSn}
    </select>
</mapper>